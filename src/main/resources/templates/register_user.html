<!doctype HTML>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>新規登録画面</title>
	<link href="/css/register_user.css" th:href="@{/css/register_user.css}" rel="stylesheet" />
</head>

<body>

	<script src="http://code.jquery.com/jquery-3.4.1.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
	<link rel="stylesheet"
			href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
	<script src="/js/util/stringUtil.js" th:src="@{/js/util/stringUtil.js}"></script>
	<script src="/js/util/validator.js" th:src="@{/js/util/validator.js}"></script>
	<script src="/js/dialogConfig.js" th:src="@{/js/dialogConfig.js}"></script>

<main>

<img class="logo" src="/img/h_logo.png">

<div class="container">
	<h2 class="title">新規ユーザー登録</h2>
	
	<table id="register" class="user">
		<tr>
			<td>
				<div class="koumokuName">氏名</div>
				<input class="form" type="text" name="familyName" placeholder="山田"maxlength="16" />
				<input class="form" type="text" name="firstName" placeholder="太郎"maxlength="16" />
			</td>
		</tr>
		<tr>
			<td>
				<div class="koumokuMail">ユーザー名(メールアドレス)</div>
				<input class="form" type="email" name="userName" placeholder="myaccount@abc.com" maxlength="32" />
				<button id="checkUserName">重複確認</button>
				<span id="checkOK" class="hidden">OK</span>
			</td>
		</tr>
		<tr>
			<td>
				<div class="koumokuPass">パスワード</div>
				<input class="form" type="password" name="password" placeholder="※半角英数字6～16字まで" maxlength="16" />
			</td>
		</tr>
		<tr>
			<td>
				<span class="info hidden">登録が完了しました。</span>
			</td>
			<td>
				<button id="confirm" disabled>確認</button>
			</td>
		</tr>
	</table>
</div>

<!-- Modal Dialog (ユーザー名重複) -->
<div th:insert="fragments/dialog_duplicated_user_name::dialogDuplicatedUserName"></div>

<!-- Modal Dialog (ユーザー入力エラー) -->
<div th:insert="fragments/dialog_input_user_error::dialogInputUserError"></div>

<!-- Modal Dialog (入力内容確認) -->
<div th:insert="fragments/dialog_input_user_confirm::dialogInputUserConfirm"></div>

</main>

<script>
// dialog_input_user_error.htmlのエラーメッセージを表示するdivのクラスを定義
const errorSelector = {
	'姓': '.familyNameError',
	'名': '.firstNameError',
	'ユーザー名': '.userNameError',
	'パスワード': '.passwordError',
};

$(() => {
	
	// jQuery-UIダイアログの初期設定
	$('#duplicatedUserName').dialog(dialogConfig.duplicatedUserName);
	$('#inputUserError').dialog(dialogConfig.inputUserError);
	$('#inputUserConfirm').dialog(dialogConfig.inputUserConfirm);
	
	$('button#checkUserName').on('click', () => {
		let userName = $('table#register input[name=userName]');
		if (isEmpty($(userName).val())) return;
		checkUserName(userName);
	});
	
	$('button#confirm').on('click', () => {
	// 入力チェック処理(validate.js:validate(checkerConfig))を呼び出す
	// 引数はvalidate.js:checkerからチェックしたい項目の変数の宣言を作成する
		let errInfo = validate({
			'familyName': checker.familyName,
			'firstName': checker.firstName,
			'userName': checker.userName,
			'password': checker.password,
		});
		if (errInfo.isError) {
			// エラーがあればエラーダイアログを表示する(volidator.js:createErrorDialog(checkerConfig))
			createErrorDialog(errInfo.errMsg);
			$("#inputUserError").dialog("open");
		} else {
			// エラーがなければ、確認ダイアログを表示する(dialogConfig.js:createConfirmDialog(checkerConfig))
			createConfirmDialog({
				'familyName': checker.familyName,
				'firstName': checker.firstName,
				'userName': checker.userName,
				'password': checker.password,
			});
			$("#inputUserConfirm").dialog("open");
		}
	});
});

	function checkUserName(userName) {
		let errInfo = validate({ 'userName': checker.userName });
		if (errInfo.isError) {
				createErrorDialog(errInfo.errMsg);
				$("#inputUserError").dialog("open");
				return;
			}
	
		$.ajax({
			type: 'POST',
			url: '/mailsystem/user/duplicatedUserName',
			data: userName,
			scriptCharset: 'utf-8'
		})
		.then((result) => {
			if (result) {	// 重複あり
				$('button#confirm').prop('disabled', true);
				$("#duplicatedUserName").dialog("open");
				//$('button#checkUserName').prop('class', '');
				$('span#checkOK').prop('class', 'hidden');
			} else {			// 重複なし
				$('button#confirm').prop('disabled', false);
				//$('button#checkUserName').prop('class', 'hidden');
				$('span#checkOK').prop('class', 'info');
			}
		}, () => {
			alert('Error: ajax connection failed.');
		});
	
}

</script>

</body>

</html>